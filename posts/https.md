---
title: https加密与证书
date: '2015-06-07'
description:
categories: 'http'
---

加密分为对称加密，和不对称加密。对称加密双方都持有私钥；不对称加密公钥是公开的，而私钥只有一方持有，公钥加密的内容，只能由对应的私钥解开，私钥加密的内容只能由对应的公钥解开。  

> B(Browser) <--> A(Server)

例如A跟B通信，A先将公钥传递给B，然后B用A的公钥加密需要传递的数据给A，只有A能够用其私钥解开。这样只要保证A的私钥不会泄露，数据内容就是比较安全的。这时候攻击者很难攻击。  
  
但是当A需要传递信息给B时，也是可以利用上面的过程通信的。但是browser/server的模式下，browser很难去维护私钥不泄露，所以这样行不通。  
  
A为了防止内容被攻击者串改，取数据的hash值摘要（digest）,然后用自己的私钥加密digest，生成签名（signature）,这样B就可以用A的公钥去解密signature，从而比对digest，确保内容没有被串改。但是，其实B很难确保自己持有的A的公钥没有被串改过，所以要找一个证书颁发中心（certificate authority，简称CA），做一个公证，证明这确实是A的公钥。  
  
于是，A需要将自己的公钥提交给CA，让CA用CA的私钥加密A的公钥以及其他相关信息，生成"数字证书"（Digital Certificate）。后面A传递内容给B时，只要附上数字证书就好了。因为CA机构是有限的几个，很好去控制，CA的公钥很难造假，于是解密取的的A的公钥肯定也是真的了。进一步，用A的公钥最终取的的内容也是完整正确的。  

## https中的SSL握手

* 浏览器将自己支持的加密规则告诉网站
* 网站从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。
* 浏览器获得证书
    - 从自己维护的受信任证书列表里对比，验证证书合法性（颁发结构、网址是否一致），如果受信任，显示小锁头，否则提示不受信任
    - 如果证书受信任，或者用户强制接受，浏览器生成一串随机密码（即浏览器的私钥），并用证书中的公钥加密
    - 使用约定好的HASH计算握手消息，用刚的随机数加密（这里的交互是对称加密）。最后连同上一步加密后的浏览器私钥，以及这一步用浏览器私钥加密后的握手消息发送给网站
* 网站接收后
    - 用自己的私钥解出浏览器的私钥
    - 在用浏览器的私钥解除握手消息，并验证HASH一致
    - 使用浏览器私钥加密一段握手消息，返回浏览器
* 浏览器解密消息，并计算HASH一致。SSL握手完成，之后所有的通信基于这个浏览器私钥进行对称加密通信。  

另外，
* TCP/IP握手，跟SSL握手是两个过程
* 证书是由证书链构成的，我们网站的证书是末节点证书，只有每层都验证合法才行

## 几种劫持方式

* session劫持：arp欺骗，将自己伪造成网关，局域网内可以看到一个ip对应两个mac。有局限性。
* dns劫持：各级 dns 服务商受到污染，将用户的请求的解析地址改为钓鱼服务器的ip地址。易被发现。
* http劫持：请求或者返回的内容被串改，或者被直接重定向走。常用，隐蔽度高。
* 流氓插件：易被发现。

## https几种攻击方式

### SSL劫持攻击

```
[浏览器] <======> [目标网站] （正常情况）
[浏览器] <======> 中间人 <======> [目标网站] （中间人攻击）
```

攻击者返回的证书一般都会被证书验证机制识别，提示证书不合法。

### SSLStrip攻击

中间人将用户重定向到一个http页面，这样就能获取用户输入的信息。防御：  

* 在配置HTTPS服务的时候加上“HTTP Strict Transport Security”配置项；或者是在代码中将所有HTTP的请求强制转移到HTTPS上，使用URL REWRITE也可以达到同样的效果
* 发送密码前JS加密一次
* 用户地址栏输入强制加上https开头

### 第三类攻击

浏览器bug等

### 另外

如今分布式计算能力提升、量子计算机，RSA算法安全性也受到挑战。  

参考：  
https://www.evernote.com/l/AIVBQV9UoX9NNZ5hV0duKrwHtwGaUjakO3s  
https://www.evernote.com/l/AIVBQV9UoX9NNZ5hV0duKrwHtwGaUjakO3s  
https://www.evernote.com/l/AIWIkMnop15GXqkfBJDXw9kphf0oY03frOw  

